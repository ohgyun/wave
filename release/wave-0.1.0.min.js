(function(){function t(t,n,i){var r=n.map(function(t){return e(t)});e._registry[t]=i.apply(null,r)}function e(t){var n=e._registry[t];if(n===void 0)throw Error('Module "'+t+'" is not defined.');return n}e._registry={},t("util",[],function(){var t={};t.extend=function(t,e,n){for(var i in e)e.hasOwnProperty(i)&&("function"==typeof n?n(i,e[i],t,e):t[i]=e[i]);return t},t.rand=function(t,e){return t+Math.floor(Math.random()*(e-t+1))},t.randFloat=function(t,e){return t+Math.random()*(e-t)};var e=0;return t.uniqueId=function(){return e++},t}),t("makePropertiable",[],function(){function t(t){var e=function(){return this.__props=this.__props||{},this.__props},n=function(t){return t},i=function(t){return t},r=function(){},o=function(){return!0},u=function(t){var n=e.call(this);if(!(t in n))throw Error('Property "'+t+'" does not exist.')};t.defineProp=function(t,u){var s={value:u.value,get:u.get||n,set:u.set||i,validate:u.validate||o,onset:u.onset||r};e.call(this)[t]=s},t.set=function(t,n){u.call(this,t);var i=e.call(this)[t];if(!i.validate())throw Error('The value "'+n+'" of "'+t+'" is invalid.');return i.value=i.set.call(this,n),i.onset.call(this,i.value),this},t.get=function(t){u.call(this,t);var n=e.call(this)[t];return n.get.call(this,n.value)}}return t}),t("makeEventable",[],function(){function t(t){var e=function(){return this.__eventMap=this.__eventMap||{},this.__eventMap},n=function(t){var n=e.call(this);if(n[t]===void 0)throw Error('The event "'+t+'" is not defined.')},i=function(t,e){if(!e)return t;for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},r=function(t,r,o){if(n.call(this,t),"function"!=typeof r)throw Error('The handler of "'+t+'" should be a function.');var u=e.call(this),s=i({func:r},o);u[t].push(s)};t.defineEvent=function(t){var n=e.call(this);return n[t]=[],this},t.on=function(t,e){return r.call(this,t,e),this},t.once=function(t,e){return r.call(this,t,e,{once:!0}),this},t.trigger=function(t){n.call(this,t);for(var i,r=e.call(this),o=r[t].slice(),u=Array.prototype.slice.call(arguments,1),s=0,a=o.length;a>s;s++)i=o[s],i.func.apply(this,u),i.once===!0&&r[t].splice(s,1);return this}}return t}),t("audioContext",[],function(){var t=new webkitAudioContext,e=t.createGain();return e.connect(t.destination),{createBufferSource:function(e){var n=t.createBufferSource();return n.connect(e),n},getMasterGain:function(){return e},createGain:function(){var n=t.createGain();return n.connect(e),n},decodeAudioData:function(){t.decodeAudioData.apply(t,arguments)},getTimeAfter:function(e){return t.currentTime+(e||0)},getTimeBefore:function(e){return t.currentTime-(e||0)}}}),t("soundLoader",["audioContext"],function(t){return{_bufferCached:{},extensions:function(){var t=new Audio;return[{codecs:["audio/mpeg;"],ext:".mp3"},{codecs:['audio/wav; codecs="1"'],ext:".wav"},{codecs:['audio/ogg; codecs="vorbis"'],ext:".ogg"},{codecs:['audio/webm; codesc="vorbis"'],ext:".webm"},{codecs:["audio/x-m4a;","audio/acc;"],ext:".m4a"}].map(function(e){var n=e.codecs.some(function(e){return!!t.canPlayType(e).replace(/^no$/,"")});return n?e.ext:null}).filter(function(t){return t})}(),load:function(t,e,n){var i=this.extensions,r=this,o=0;return this._bufferCached[t]?(e.call(n,this._bufferCached[t]),void 0):(function u(){var s=t+i[o],a=function(){if(o++,o===i.length)throw Error('Cannot load "'+t+'" file.');u()};r._tryToLoad(s,a,e,n)}(),void 0)},_tryToLoad:function(t,e,n,i){var r=this;this._requestAsyc({url:t,success:function(e){r._decodeAudioData(t,e,n,i)},fail:function(){e()}})},_requestAsyc:function(t){var e=new XMLHttpRequest;e.open("GET",t.url,!0),e.responseType="arraybuffer",e.onload=function(){var e=this.status;e>=200&&300>e||304===e?t.success(this.response):t.fail()},e.onerror=function(){t.fail()},e.send()},_decodeAudioData:function(e,n,i,r){var o=this,u=e.substring(0,e.lastIndexOf("."));t.decodeAudioData(n,function(t){o._bufferCached[u]=t,i.call(r,t)})}}}),t("master",["audioContext","makePropertiable"],function(t,e){var n={},i=t.getMasterGain();return e(n),n.defineProp("volume",{value:1,get:function(t){return this.get("muted")?0:t},onset:function(t){i.gain.value=t}}),n.defineProp("muted",{value:!1,onset:function(){i.gain.value=this.get("volume")}}),n}),t("Timer",["util"],function(t){function e(){this._timers=[]}return t.extend(e.prototype,{now:function(){return(new Date).getTime()},create:function(t,e){var n=1e3*e,i=this.now()+n,r={},o=setTimeout(function(){t();var e=this._timers.indexOf(r);this._timers.splice(e,1)}.bind(this),n);r.callTimeMills=i,r.timerKey=o,this._timers.push(r)},removeAfter:function(t){var e=this.now()+1e3*t;this._timers=this._timers.filter(function(t){return t.callTimeMills>e?(clearTimeout(t.timerKey),!1):!0})}}),e}),t("BufferSource",["audioContext","soundLoader","Timer","util"],function(t,e,n,i){function r(t){this._buffers=[],this._currBuffer=null,this._bufferSource=null,this._gainNode=t,this._timer=new n,this._startTime=0,this._pausedTime=0}var o=r.prototype;return i.extend(o,{load:function(t,n){this._buffers.length=0;var i=this,r=t.length;t.forEach(function(t){e.load(t,function(t){i._buffers.push(t),i._buffers.length===r&&n()})})},play:function(e){this._refreshBufferSource(),this._setPitch(e.pitch);var n=t.getTimeAfter(e.delay),i=this._getDuration(),r=e.delay||0,o=r+i,u=this._pausedTime-this._startedTime;this._bufferSource.start(n,u),"function"==typeof e.onplay&&this._timer.create(e.onplay,r),"function"==typeof e.onend&&this._timer.create(e.onend,o),this._startedTime=n,this._pausedTime=0},_refreshBufferSource:function(){var e=t.createBufferSource(this._gainNode);this._isNotPaused()&&(this._currBuffer=this._pickBufferRandomly()),e.buffer=this._currBuffer,this._bufferSource=e},_isNotPaused:function(){return 0===this._pausedTime},_pickBufferRandomly:function(){var t=this._buffers.length;return t>0?this._buffers[i.rand(0,t-1)]:null},stop:function(e,n){var i=e||0;if(this._bufferSource){var r=t.getTimeAfter(e);this._bufferSource.stop(r),this._bufferSource=null,this._timer.removeAfter(i),"function"==typeof n&&this._timer.create(n,e)}},pause:function(e,n){this.stop(e,n),this._pausedTime=t.getTimeAfter(e)},_setPitch:function(t){this._bufferSource.playbackRate.value=t},_getDuration:function(){var t=this._bufferSource.playbackRate.value;return this._currBuffer.duration/t}}),r}),t("Sound",["audioContext","BufferSource","makePropertiable","makeEventable","util"],function(t,e,n,i,r){function o(n,i){function u(t){return function(e){var n=this.get(t),i=e*(1+n[0]),o=e*(1+n[1]);return r.randFloat(i,o)}}function s(t){return t?t===!0?[-.3,.3]:t:[0,0]}var a=this;this._gainNode=t.createGain(),this._bufferSource=new e(this._gainNode),this.defineProp("name",{value:n}),this.defineProp("src",{value:"",set:function(t){return"string"==typeof t?[t]:t},onset:function(){this._load()}}),this.defineProp("loadState",{value:o.STATE_NOT_LOADED}),this.defineProp("autoplay",{value:!1}),this.defineProp("volume",{value:1,get:function(t){return this.get("muted")?0:u("volumeVariation").call(this,t)}}),this.defineProp("volumeVariation",{value:!1,get:s}),this.defineProp("pitch",{value:1,set:function(t){return isNaN(t)?1:t},get:u("pitchVariation")}),this.defineProp("pitchVariation",{value:!1,get:s}),this.defineProp("nestedPlay",{value:!1}),this.defineProp("muted",{value:!1}),this.defineEvent("load"),this.defineEvent("play"),this.defineEvent("end"),this.defineEvent("stop"),this.defineEvent("pause"),r.extend(this.opts,i,function(t,e){a.set(t,e)})}o.STATE_NOT_LOADED=0,o.STATE_LOADING=1,o.STATE_LOADED=2;var u=o.prototype;return n(u),i(u),r.extend(u,{_load:function(){var t=this.get("loadState");if(t!==o.STATE_LOADED&&t!==o.STATE_LOADING){this.set("loadState",o.STATE_LOADING);var e=this.get("src");e&&this._bufferSource.load(e,function(){this.set("loadState",o.STATE_LOADED),this.trigger("load"),this.get("autoplay")&&this.play()}.bind(this))}},play:function(t){return this._isNotLoaded()?(this._runOnceOnLoad(function(){this.play(t)}.bind(this)),this):(this.get("nestedPlay")||this._stop(t),this._play(t),this)},_isNotLoaded:function(){return this.get("loadState")!==o.STATE_LOADED},_runOnceOnLoad:function(t){this.once("load",t)},_play:function(t){this._gainNode.gain.value=this.get("volume"),this._bufferSource.play({delay:t,pitch:this.get("pitch"),onplay:function(){this.trigger("play")}.bind(this),onend:function(){this.trigger("end")}.bind(this)})},stop:function(t){return this._isNotLoaded()?(this._runOnceOnLoad(function(){this.stop(t)}.bind(this)),this):(this._stop(t),this)},_stop:function(t){this._bufferSource.stop(t,function(){this.trigger("stop")}.bind(this))},pause:function(t){return this._isNotLoaded()?(this._runOnceOnLoad(function(){this.pause(t)}.bind(this)),this):(this._pause(t),this)},_pause:function(t){this._bufferSource.pause(t,function(){this.trigger("pause")}.bind(this))},volume:function(t){return isNaN(t)?this.get("volume"):(this.set("volume",t),this)},mute:function(){return this.set("muted",!0),this},unmute:function(){return this.set("muted",!1),this},getGain:function(){return this._gainNode},clone:function(){var t=this.get("name")+"-clone-"+r.uniqueId(),e=new o(t,{src:this.get("src")});return e}}),o}),t("SoundMixed",["audioContext","makePropertiable","util"],function(t,e,n){function i(e,n,i){this._sounds=n,this._onplay=i,this._gainNode=t.createGain(),this.defineProp("name",{value:e}),this.defineProp("volume",{value:1,get:function(t){return this.get("muted")?0:t}}),this.defineProp("muted",{value:!1}),this._connectGainNode()}var r=i.prototype;return e(r),n.extend(r,{_connectGainNode:function(){var t=this;this._sounds.forEach(function(e){var n=e.getGain();n.disconnect(),n.connect(t._gainNode)})},play:function(t){t=t||0;var e=this.get("volume");return setTimeout(function(){this._gainNode.gain.value=e,this._onplay.apply(this,this._sounds)}.bind(this),1e3*t),this},stop:function(t){return this._eachSoundsAfter("stop",t),this},_eachSoundsAfter:function(t,e){Array.prototype.slice.call(arguments,1),e=e||0,setTimeout(function(){this._sounds.forEach(function(e){e[t]()})}.bind(this),1e3*e)},pause:function(t){return this._eachSoundsAfter("pause",t),this},mute:function(){return this.set("muted",!0),this},unmute:function(){return this.set("muted",!1),this},volume:function(t){return isNaN(t)?this.get("volume"):(this.set("volume",t),this)},clone:function(){var t=this.get("name")+"-clone-"+n.uniqueId(),e=this._sounds.map(function(t){return t.clone()});return new i(t,e,this._onplay)},getGain:function(){return this._gainNode}}),i}),t("wave",["master","Sound","SoundMixed"],function(t,e,n){var i={},r=function(t){var e=i[t];if(!e)throw Error('The "'+t+'" object does not exist.');return e};return r.create=function(t,n){if(i[t])throw Error('"'+t+'" object already exists.');var r=new e(t,n);return i[t]=r,r},r.volume=function(e){return isNaN(e)?t.get("volume"):(t.set("volume",e),this)},r.mute=function(){return t.set("muted",!0),this},r.unmute=function(){return t.set("muted",!1),this},r.reset=function(){return i={},this.unmute(),this.volume(1),this},r.mix=function(t,e,o){var u=e.map(function(t){return r(t).clone()}),s=new n(t,u,o);return i[t]=s,s},r}),window.wave=e("wave")})();